<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dienstplan Pro - Helios Notaufnahme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs (Modular v11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseCore = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, onSnapshot, serverTimestamp };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #020617;
            --text-primary: #ffffff; 
            --text-secondary: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --table-header-bg: #0f172a;
            --row-hover: rgba(255, 255, 255, 0.05);
            --separator-color: rgba(255, 255, 255, 0.08);
            --holiday-color: rgba(234, 179, 8, 0.35);
            --weekend-color: rgba(59, 130, 246, 0.15);
            --zoom-factor: 1;
            --name-shadow: rgba(0,0,0,0.5);
        }

        .light-mode {
            --bg-color: #f8fafc;
            --text-primary: #0f172a; 
            --text-secondary: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.95); 
            --glass-border: rgba(0, 0, 0, 0.1);
            --table-header-bg: #ffffff;
            --row-hover: rgba(59, 130, 246, 0.05); 
            --separator-color: rgba(15, 23, 42, 0.08);
            --holiday-color: rgba(234, 179, 8, 0.25);
            --weekend-color: rgba(59, 130, 246, 0.08);
            --name-shadow: rgba(15, 23, 42, 0.05);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            overflow: hidden;
            transition: background 0.4s ease, color 0.4s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .glass { background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); }
        .name-col-bg { background: var(--bg-color) !important; box-shadow: 4px 0 12px -4px var(--name-shadow); z-index: 50; }
        .sticky-left { position: sticky; left: 0; z-index: 40; }

        .holiday-cell { background-color: var(--holiday-color) !important; }
        .weekend-cell { background-color: var(--weekend-color) !important; }
        .row-separator td { border-bottom: 1px solid var(--separator-color); }
        .warning-cell { background-color: rgba(225, 29, 72, 0.15) !important; }
        .dragging { opacity: 0.5; background: rgba(59, 130, 246, 0.2) !important; }

        #columnOverlay, #modalOverlay, #addEmpOverlay, #editEmpOverlay, #shiftModalOverlay, #yearViewOverlay, #noteModalOverlay, #toast {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            z-index: 200; align-items: center; justify-content: center;
        }

        #toast { background: transparent; backdrop-filter: none; height: auto; top: 1rem; pointer-events: none; }
        #rosterTable { zoom: var(--zoom-factor); transform-origin: top left; }

        @media print {
            @page { size: A3 landscape; margin: 10mm; }
            body { background: white !important; color: black !important; overflow: visible !important; }
            .no-print { display: none !important; }
            main { border: none !important; background: transparent !important; width: 100% !important; overflow: visible !important; }
            #tableContainer { overflow: visible !important; height: auto !important; }
            #rosterTable { zoom: 1 !important; width: 100% !important; border-collapse: collapse !important; border: 1px solid black !important; }
            thead { display: table-header-group !important; }
            tfoot { display: table-footer-group !important; }
            tr { page-break-inside: avoid !important; }
            .name-col-bg { background: white !important; border-right: 1px solid black !important; box-shadow: none !important; }
            th, td { border: 0.5pt solid black !important; -webkit-print-color-adjust: exact; color: black !important; }
            .sticky-left { position: static !important; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(120, 120, 120, 0.3); border-radius: 10px; }
        
        /* Zoom Slider Styling */
        input[type=range].zoom-slider::-webkit-slider-runnable-track { background: rgba(255,255,255,0.1); height: 4px; border-radius: 2px; }
        input[type=range].zoom-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #3b82f6; margin-top: -4px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="toast">
        <div class="glass px-6 py-3 rounded-2xl shadow-2xl border border-white/20 flex items-center gap-3">
            <div id="toastIcon" class="text-blue-500"></div>
            <span id="toastMessage" class="text-sm font-bold text-current"></span>
        </div>
    </div>

    <!-- Modale -->
    <div id="yearViewOverlay" onclick="closeYearModal()">
        <div class="glass p-8 rounded-3xl w-full md:w-[450px] shadow-2xl flex flex-col gap-6" onclick="event.stopPropagation()">
            <h3 class="text-xl font-black text-center flex items-center justify-center gap-3 text-current">
                <i data-lucide="calendar"></i> Jahresplaner <span id="yearDisplay" class="text-blue-500">2026</span>
            </h3>
            <div class="grid grid-cols-3 gap-3" id="monthGrid"></div>
            <div class="flex gap-2 justify-center border-t border-white/10 pt-4">
                <button onclick="changeYear(-1)" class="p-2 glass rounded-xl text-current transition-all"><i data-lucide="chevron-left"></i></button>
                <button onclick="closeYearModal()" class="px-8 py-2 bg-blue-600 text-white rounded-xl text-xs font-bold shadow-lg">Schließen</button>
                <button onclick="changeYear(1)" class="p-2 glass rounded-xl text-current transition-all"><i data-lucide="chevron-right"></i></button>
            </div>
        </div>
    </div>

    <!-- Einstellungen Modal -->
    <div id="columnOverlay" onclick="closeColumnModal(event)">
        <div class="glass p-8 rounded-3xl w-full md:w-96 shadow-2xl flex flex-col gap-4 overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-center text-current">Einstellungen</h3>
            <div class="flex flex-col gap-3">
                <button onclick="loadCloudData()" class="w-full py-3 bg-blue-600/20 text-blue-400 rounded-xl text-[11px] font-black border border-blue-500/20 flex items-center justify-center gap-2 transition-all active:scale-95">
                    <i data-lucide="refresh-cw" size="14"></i> Cloud-Daten erzwingen
                </button>
                <div class="border-y border-white/10 py-4 my-2">
                    <p class="text-[10px] uppercase font-black text-slate-500 mb-3">Dienst-Konfiguration</p>
                    <button onclick="openShiftModal()" class="w-full py-3 bg-emerald-600/20 text-emerald-400 rounded-xl text-[11px] font-black border border-emerald-500/20 flex items-center justify-center gap-2 transition-all active:scale-95">
                        <i data-lucide="edit-3" size="14"></i> Dienste erstellen & anpassen
                    </button>
                </div>
                
                <div>
                    <p class="text-[10px] uppercase font-black text-slate-500 mb-2">Sichtbare Spalten</p>
                    <div class="flex flex-col gap-2" id="columnToggleList"></div>
                </div>

                <div>
                    <p class="text-[10px] uppercase font-black text-slate-500 mb-2 tracking-widest mt-4">Schichten zählen (Fußzeile)</p>
                    <div class="flex flex-wrap gap-2 pt-2" id="shiftToggleList"></div>
                </div>
            </div>
            <button onclick="closeColumnModal()" class="w-full py-4 mt-6 bg-blue-600 text-white rounded-xl font-bold">Fertig</button>
        </div>
    </div>

    <!-- Schicht-Editor Modal -->
    <div id="shiftModalOverlay">
        <div class="glass p-8 rounded-3xl w-full md:w-[500px] shadow-2xl flex flex-col gap-6" onclick="event.stopPropagation()">
            <h3 class="text-lg font-black text-center text-current flex items-center justify-center gap-2"><i data-lucide="list-plus"></i> Dienstarten</h3>
            <div class="overflow-y-auto custom-scrollbar max-h-60 pr-2 flex flex-col gap-3" id="shiftTypeListContainer"></div>
            <button onclick="closeShiftModal()" class="py-4 rounded-xl bg-blue-600 text-white font-bold">Speichern</button>
        </div>
    </div>

    <!-- Mitarbeiter hinzufügen Modal -->
    <div id="addEmpOverlay">
        <div class="glass p-8 rounded-3xl w-96 shadow-2xl flex flex-col gap-4 text-current">
            <h3 class="text-lg font-bold text-center">Neuer Kollege</h3>
            <input type="text" id="newEmpName" placeholder="Name, Vorname" class="bg-black/5 border border-white/10 rounded-xl p-3 text-sm focus:outline-none">
            <input type="text" id="newEmpRole" placeholder="Rolle" class="bg-black/5 border border-white/10 rounded-xl p-3 text-sm focus:outline-none">
            <input type="number" id="newEmpStatus" value="100" class="bg-black/5 border border-white/10 rounded-xl p-3 text-sm focus:outline-none">
            <div class="flex gap-2">
                <button onclick="closeAddEmpOverlay()" class="flex-1 py-3 rounded-xl bg-black/5">Abbrechen</button>
                <button onclick="addNewEmployee()" class="flex-1 py-3 rounded-xl bg-emerald-600 text-white font-bold">Hinzufügen</button>
            </div>
        </div>
    </div>

    <!-- Mitarbeiter bearbeiten Modal -->
    <div id="editEmpOverlay">
        <div class="glass p-8 rounded-3xl w-96 shadow-2xl flex flex-col gap-6" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-center">Mitarbeiter bearbeiten</h3>
            <input type="text" id="editEmpNameInput" class="bg-black/5 border border-white/10 rounded-xl p-3 text-sm focus:outline-none">
            <input type="text" id="editEmpRoleInput" class="bg-black/5 border border-white/10 rounded-xl p-3 text-sm focus:outline-none">
            <div class="flex gap-2">
                <button onclick="closeEditModal()" class="flex-1 py-3 rounded-xl bg-black/5">Abbrechen</button>
                <button onclick="applyEditEmployee()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold">Speichern</button>
            </div>
            <button onclick="confirmDeleteEmployee()" class="w-full py-3 border border-rose-500 text-rose-500 rounded-xl text-xs font-bold">Löschen</button>
        </div>
    </div>

    <!-- Slider Modal -->
    <div id="modalOverlay">
        <div class="glass p-8 rounded-3xl w-80 shadow-2xl flex flex-col gap-6">
            <h3 class="text-lg font-bold text-center" id="modalTitle">Anpassung</h3>
            <div class="flex flex-col gap-2">
                <div class="flex justify-between text-xs font-mono">
                    <span id="modalEmpName">Name</span>
                    <span id="sliderValueText" class="text-blue-500 font-bold">100%</span>
                </div>
                <input type="range" id="statusSlider" min="-100" max="250" step="1" oninput="updateSliderLabel()" class="w-full accent-blue-600">
            </div>
            <div class="flex gap-2">
                <button onclick="closeSliderModal()" class="flex-1 py-3 rounded-xl bg-black/5">Abbrechen</button>
                <button onclick="applySliderValue()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold">Übernehmen</button>
            </div>
        </div>
    </div>

    <!-- Notiz Modal -->
    <div id="noteModalOverlay">
        <div class="glass p-8 rounded-3xl w-96 shadow-2xl flex flex-col gap-6" onclick="event.stopPropagation()">
            <h3 class="text-lg font-black text-center flex items-center justify-center gap-2"><i data-lucide="sticky-note" class="text-yellow-500"></i> Notiz</h3>
            <textarea id="noteInput" rows="4" class="bg-black/5 border border-white/10 rounded-2xl p-4 text-sm focus:outline-none resize-none"></textarea>
            <div class="flex gap-2">
                <button onclick="closeNoteModal()" class="flex-1 py-3 rounded-xl bg-black/5">Abbrechen</button>
                <button onclick="saveNote()" class="flex-1 py-3 rounded-xl bg-yellow-600 text-white font-bold">Speichern</button>
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div class="flex flex-col h-full w-full relative z-10 overflow-hidden">
        <header class="glass m-2 md:m-4 p-3 rounded-2xl shadow-2xl no-print flex items-center justify-between gap-4">
            <div class="flex items-center gap-3 shrink-0">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-500 rounded-xl flex items-center justify-center">
                    <i data-lucide="calendar" class="text-white" size="20"></i>
                </div>
                <div class="hidden sm:block">
                    <h1 class="text-lg font-black tracking-tight leading-none mb-0.5">Dienstplan PRO</h1>
                    <p class="text-[9px] text-slate-500 uppercase font-bold tracking-wider" id="syncLabel">Helios Duisburg</p>
                </div>
            </div>

            <div class="flex items-center gap-2 bg-black/5 p-1 rounded-2xl border border-white/5 ml-auto overflow-x-auto no-scrollbar">
                
                <div class="flex items-center bg-black/20 rounded-xl p-0.5 border border-white/5 shrink-0 mr-1">
                    <button id="viewMonthBtn" onclick="toggleViewMode('month')" class="px-3 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all">Monat</button>
                    <button id="viewWeekBtn" onclick="toggleViewMode('week')" class="px-3 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all">Woche</button>
                </div>

                <div class="flex items-center bg-black/20 rounded-xl p-0.5 border border-white/5 shrink-0">
                    <button onclick="handleNavigation(-1)" class="p-1.5 hover:bg-white/10 rounded-lg"><i data-lucide="chevron-left" size="14"></i></button>
                    <div id="monthLabel" onclick="openYearModal()" class="px-3 font-black text-[11px] uppercase cursor-pointer min-w-[110px] text-center">Monat</div>
                    <button onclick="handleNavigation(1)" class="p-1.5 hover:bg-white/10 rounded-lg"><i data-lucide="chevron-right" size="14"></i></button>
                </div>

                <!-- Zoom Regler im Header -->
                <div class="hidden lg:flex items-center gap-2 px-3 py-1 bg-black/20 rounded-xl border border-white/5 shrink-0">
                    <button onclick="adjustZoom(-0.05)" class="text-slate-500 hover:text-white transition-colors"><i data-lucide="minus-circle" size="14"></i></button>
                    <input type="range" id="zoomSlider" min="0.5" max="1.5" step="0.05" value="1" oninput="adjustZoom(0)" class="w-16 h-1 appearance-none bg-white/10 rounded-full zoom-slider cursor-pointer accent-blue-500">
                    <button onclick="adjustZoom(0.05)" class="text-slate-500 hover:text-white transition-colors"><i data-lucide="plus-circle" size="14"></i></button>
                    <span id="zoomText" class="text-[9px] font-black text-blue-500 min-w-[28px]">100%</span>
                </div>

                <div id="headerWorkingDays" class="px-3 py-2 bg-blue-500/10 text-blue-400 text-[10px] font-black rounded-xl border border-blue-500/20 hidden md:block shrink-0">
                    -- Arbeitstage
                </div>

                <div class="flex items-center gap-1 shrink-0 ml-2">
                    <button onclick="openAddEmpOverlay()" class="p-2 hover:bg-emerald-500/20 rounded-xl text-emerald-500" title="Kollegen hinzufügen"><i data-lucide="user-plus" size="16"></i></button>
                    <button onclick="openColumnModal()" class="p-2 hover:bg-white/10 rounded-xl text-slate-400" title="Einstellungen"><i data-lucide="settings-2" size="16"></i></button>
                    <button onclick="toggleTheme()" class="p-2 hover:bg-white/10 rounded-xl text-slate-400" title="Design wechseln"><i data-lucide="sun" id="themeIcon" size="16"></i></button>
                    <button onclick="exportToPDF()" class="px-3 py-2 bg-slate-700 text-white rounded-xl text-[11px] font-black shadow-lg flex items-center gap-2 active:scale-95 transition-all">
                        <i data-lucide="file-down" size="14"></i><span class="hidden lg:inline">Export</span>
                    </button>
                    <button id="saveBtn" onclick="saveData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-[11px] font-black shadow-lg flex items-center gap-2 active:scale-95 transition-all">
                        <i data-lucide="save" id="saveIcon" size="14"></i><span class="hidden lg:inline">Sichern</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="hidden print:block mb-4 border-b-2 border-slate-900 pb-2 px-4">
            <h1 class="text-2xl font-bold uppercase text-slate-900">Dienstplan Helios Duisburg - Notaufnahme</h1>
            <p class="text-sm font-black text-slate-700" id="printMonthLabel"></p>
        </div>

        <div class="flex flex-1 overflow-hidden relative mb-20 md:mb-0">
            <aside class="fixed bottom-0 left-0 w-full z-[100] md:relative md:w-20 lg:w-48 p-2 md:p-0 no-print">
                <div class="glass p-3 md:p-4 rounded-t-3xl md:rounded-2xl h-full flex flex-row md:flex-col gap-2 overflow-x-auto no-scrollbar">
                    <div id="shiftPalette" class="flex flex-row md:flex-col gap-2 items-center"></div>
                </div>
            </aside>

            <main class="flex-1 glass m-2 md:m-4 mt-0 rounded-2xl md:rounded-3xl overflow-hidden flex flex-col shadow-2xl relative">
                <div class="overflow-x-auto overflow-y-auto flex-1 custom-scrollbar" id="tableContainer">
                    <table class="w-full border-separate border-spacing-0" id="rosterTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                        <tfoot id="tableFoot" class="sticky bottom-0 z-40 bg-[var(--bg-color)]"></tfoot>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <script>
     // --- Firebase State ---
let db, auth, user, firebaseApp;

const appId = "helios-notaufnahme-duisburg";

const firebaseConfig = {
    apiKey: "AIzaSyD3HcZOIv6Wyg3_5xoBnSnz-Eb4fgLr0SA",
    authDomain: "dienstplanprogramm.firebaseapp.com",
    projectId: "dienstplanprogramm",
    storageBucket: "dienstplanprogramm.firebasestorage.app",
    messagingSenderId: "193664964493",
    appId: "1:193664964493:web:e99e822739cb13c8df0fc4"
};

        let viewSettings = JSON.parse(localStorage.getItem('helios_view_settings')) || { status: true, soll: true, ist: true, diff: true, prev: true };
        let shiftCounterSettings = JSON.parse(localStorage.getItem('helios_counter_settings')) || { FD: true, SD: true, ND: true, ZD: true };

        const INITIAL_EMPLOYEES = [
            { id: '1', name: 'Adams, Hendrik', role: 'Stationsleitung', status: '100%', prevOvertime: 0 },
            { id: '2', name: 'Fuchsa, Jennifer', role: 'stellv. Leitung', status: '100%', prevOvertime: 0 },
            { id: '3', name: 'Günter, Stephanie', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '4', name: 'Blank, Alexandra', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '5', name: 'Friedrich, Kristina', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '6', name: 'Weienberg, Hanna', role: 'Fachkraft', status: '100%', prevOvertime: 0 },
            { id: '7', name: 'Hackmann, Matthias', role: 'Pflegekraft', status: '90%', prevOvertime: 0 },
            { id: '8', name: 'Buchmüller, Jörg', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '9', name: 'Rösken, Katrin', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '10', name: 'Theißen, Jennifer', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '11', name: 'Daniels, Justin', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '12', name: 'Kaymaz, Melda', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '13', name: 'Kühn, Philipp', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '14', name: 'Strachanski, Julia', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '15', name: 'Preußner, Pauline', role: 'Azubi', status: '100%', prevOvertime: 0 },
            { id: '16', name: 'Bielok, Lara', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '17', name: 'Wüstkamp, Bianca', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
            { id: '18', name: 'Bondzau, Martina', role: 'Pflegekraft', status: '100%', prevOvertime: 0 }
        ];

        let SHIFT_TYPES = JSON.parse(localStorage.getItem('helios_shifts')) || {
            FD: { label: 'Frühdienst', color: 'bg-cyan-400', textColor: 'text-cyan-950', hours: 7.7 },
            SD: { label: 'Spätdienst', color: 'bg-fuchsia-500', textColor: 'text-white', hours: 7.7 },
            ZD: { label: 'Zwischendienst', color: 'bg-indigo-500', textColor: 'text-white', hours: 7.7 },
            ND: { label: 'Nachtdienst', color: 'bg-orange-600', textColor: 'text-white', hours: 9.5 },
            U:  { label: 'Urlaub', color: 'bg-yellow-400', textColor: 'text-yellow-950', hours: 7.7 },
            K:  { label: 'Krank', color: 'bg-rose-500', textColor: 'text-white', hours: 7.7 },
            LT: { label: 'Leitungstag', color: 'bg-emerald-400', textColor: 'text-emerald-950', hours: 7.7 },
            X:  { label: 'Frei', color: 'bg-white/10', textColor: 'text-slate-500', hours: 0 }
        };

        let EMPLOYEES = JSON.parse(localStorage.getItem('helios_employees')) || INITIAL_EMPLOYEES;
        let roster = JSON.parse(localStorage.getItem('helios_roster')) || {};
        let rosterNotes = JSON.parse(localStorage.getItem('helios_roster_notes')) || {};
        let currentDate = new Date(2026, 3, 1);
        let activeShift = 'FD';
        let viewMode = 'month';
        let draggingIndex = null;
        let editingEmpIndex = null;
        let editingField = 'status';
        let noteTarget = null;

    async function initFirebase() {

    if (!window.firebaseCore) {
        showToast("Firebase nicht geladen", "alert-circle");
        return;
    }

    const {
        initializeApp,
        getAuth,
        signInAnonymously,
        getFirestore,
        onAuthStateChanged
    } = window.firebaseCore;

    try {

        firebaseApp = initializeApp(firebaseConfig);

        auth = getAuth(firebaseApp);

        db = getFirestore(firebaseApp);

        await signInAnonymously(auth);

        onAuthStateChanged(auth, (u) => {

            if (u) {

                user = u;

                document.getElementById('syncLabel').innerText =
                    "Sync: Online";

                loadCloudData();

            } else {

                document.getElementById('syncLabel').innerText =
                    "Sync: Offline";

            }

        });

    } catch (error) {

        console.error(error);

        showToast("Firebase Fehler", "alert-circle");

    }

}

        // --- Core Functions ---
        function toggleViewMode(mode) { viewMode = mode; updateViewButtons(); renderRoster(); }
        function updateViewButtons() {
            const mBtn = document.getElementById('viewMonthBtn'); const wBtn = document.getElementById('viewWeekBtn');
            mBtn.className = `px-3 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all ${viewMode==='month'?'bg-blue-600 text-white shadow-lg':'text-slate-500 hover:text-white'}`;
            wBtn.className = `px-3 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all ${viewMode==='week'?'bg-blue-600 text-white shadow-lg':'text-slate-500 hover:text-white'}`;
        }
        function handleNavigation(dir) { currentDate.setMonth(currentDate.getMonth() + dir); renderRoster(); }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const icon = document.getElementById('themeIcon');
            icon.setAttribute('data-lucide', document.body.classList.contains('light-mode') ? 'moon' : 'sun');
            lucide.createIcons();
        }

        function handleDragStart(e, idx) { draggingIndex = idx; e.currentTarget.classList.add('dragging'); }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDrop(e, idx) {
            e.preventDefault();
            if (draggingIndex === null || draggingIndex === idx) return;
            const moved = EMPLOYEES.splice(draggingIndex, 1)[0];
            EMPLOYEES.splice(idx, 0, moved); draggingIndex = null;
            renderRoster(); saveData();
        }

        // --- Holiday & Workday Logic ---
        function getHolidaysNRW(year) {
            const f = Math.floor, G = year % 19, C = f(year / 100), H = (C - f(C / 4) - f((8 * C + 13) / 25) + 19 * G + 15) % 30, I = H - f(H / 28) * (1 - f(29 / (H + 1)) * f((21 - G) / 11)), J = (year + f(year / 4) + I + 2 - C + f(C / 4)) % 7, L = I - J, month = 3 + f((L + 40) / 44), day = L + 28 - 31 * f(month / 4);
            const easter = new Date(year, month - 1, day);
            const add = (d, n) => { const r = new Date(d); r.setDate(r.getDate()+n); return r.toISOString().split('T')[0]; };
            return {
                [`${year}-01-01`]: "Neujahr",
                [add(easter, -2)]: "Karfreitag",
                [add(easter, 1)]: "Ostermontag",
                [`${year}-05-01`]: "Tag der Arbeit",
                [add(easter, 39)]: "Christi Himmelfahrt",
                [add(easter, 50)]: "Pfingstmontag",
                [add(easter, 60)]: "Fronleichnam",
                [`${year}-10-03`]: "Tag der Dt. Einheit",
                [`${year}-11-01`]: "Allerheiligen",
                [`${year}-12-25`]: "1. Weihnachtstag",
                [`${year}-12-26`]: "2. Weihnachtstag"
            };
        }

        function calculateWorkingDays(year, month) {
            const h = getHolidaysNRW(year);
            let count = 0;
            const d = new Date(year, month, 1);
            while (d.getMonth() === month) {
                const k = d.toISOString().split('T')[0];
                if (d.getDay() !== 0 && d.getDay() !== 6 && !h[k]) count++;
                d.setDate(d.getDate() + 1);
            }
            return count;
        }

        function renderRoster() {
            const year = currentDate.getFullYear(), month = currentDate.getMonth();
            const allDays = []; const d = new Date(year, month, 1);
            while (d.getMonth() === month) { allDays.push(new Date(d)); d.setDate(d.getDate() + 1); }
            const visibleDays = viewMode === 'month' ? allDays : allDays.slice(0, 7);
            
            const holidays = getHolidaysNRW(year);
            const workDays = calculateWorkingDays(year, month);
            const monthSoll = workDays * 7.7;
            
            document.getElementById('monthLabel').innerText = currentDate.toLocaleString('de-DE', { month: 'long', year: 'numeric' });
            document.getElementById('headerWorkingDays').innerText = `${workDays} Arbeitstage`;

            const hidden = (key) => viewSettings[key] ? '' : 'hidden-col';
            let headHTML = `<tr><th class="p-3 text-left text-[10px] font-black sticky-left name-col-bg border-b border-black/10 min-w-[140px]">KOLLEGE</th>
                <th class="p-1 text-center text-[9px] font-black border-b border-black/10 ${hidden('status')}">VZ</th>
                <th class="p-1 text-center text-[9px] font-black border-b border-black/10 ${hidden('soll')}">Soll</th>
                <th class="p-1 text-center text-[9px] font-black border-b border-black/10 ${hidden('ist')}">Ist</th>
                <th class="p-1 text-center text-[9px] font-black border-b border-black/10 ${hidden('diff')}">+/-</th>
                <th class="p-1 text-center text-[9px] font-black border-b border-black/10 text-blue-500 ${hidden('prev')}">Vmt</th>`;
            
            visibleDays.forEach(day => {
                const k = day.toISOString().split('T')[0];
                const isH = !!holidays[k];
                const isW = day.getDay() === 0 || day.getDay() === 6;
                headHTML += `<th class="p-2 border-b border-black/10 min-w-[40px] ${isH ? 'holiday-cell' : (isW ? 'weekend-cell' : '')}">
                    <div class="flex flex-col items-center">
                        <span class="text-[8px] opacity-50 uppercase">${day.toLocaleDateString('de-DE', { weekday: 'short' })}</span>
                        <span class="text-xs font-black ${isH ? 'text-orange-500' : ''}">${day.getDate()}</span>
                    </div>
                </th>`;
            });
            document.getElementById('tableHead').innerHTML = headHTML + `</tr>`;

            const dailyCounts = {};
            visibleDays.forEach(day => {
                const k = day.toISOString().split('T')[0];
                dailyCounts[k] = {};
                Object.keys(SHIFT_TYPES).forEach(sk => dailyCounts[k][sk] = 0);
                EMPLOYEES.forEach(e => {
                    const s = (roster[e.id] || {})[k];
                    if(s) dailyCounts[k][s]++;
                });
            });

            let bodyHTML = "";
            EMPLOYEES.forEach((emp, idx) => {
                let ist = 0; const eRost = roster[emp.id] || {}, eNotes = rosterNotes[emp.id] || {};
                allDays.forEach(day => { 
                    const k = day.toISOString().split('T')[0]; 
                    if (eRost[k] && SHIFT_TYPES[eRost[k]]) ist += SHIFT_TYPES[eRost[k]].hours; 
                });
                
                const empSoll = monthSoll * (parseInt(emp.status) / 100);
                const diff = ist - empSoll;

                let dHTML = "";
                visibleDays.forEach(day => {
                    const k = day.toISOString().split('T')[0]; 
                    const s = eRost[k], n = eNotes[k], isH = !!holidays[k];
                    dHTML += `<td onclick="handleCellClick('${emp.id}', '${k}', '${emp.name}')" class="p-0.5 border-r border-black/5 text-center ${isH ? 'holiday-cell' : ''}">
                        <div class="h-8 w-full rounded flex flex-col items-center justify-center transition-all ${s ? `${SHIFT_TYPES[s].color} ${SHIFT_TYPES[s].textColor} shadow-md` : 'hover:bg-blue-500/5'}">
                            <span class="text-[10px] font-black">${s || ''}</span>
                            ${n ? '<div class="w-1.5 h-1.5 rounded-full bg-yellow-500 mt-0.5 shadow-sm"></div>' : ''}
                        </div>
                    </td>`;
                });

                bodyHTML += `<tr draggable="true" ondragstart="handleDragStart(event, ${idx})" ondragover="handleDragOver(event)" ondrop="handleDrop(event, ${idx})" class="group border-b border-black/5 hover:bg-[var(--row-hover)]">
                    <td class="p-3 sticky-left name-col-bg border-r border-black/5 cursor-move">
                        <div class="font-black text-[11px] uppercase hover:text-blue-500" onclick="openEditModal(${idx})">${emp.name}</div>
                        <div class="text-[8px] text-slate-500 truncate uppercase tracking-tighter">${emp.role}</div>
                    </td>
                    <td class="p-1 text-center text-[9px] font-bold text-slate-400 cursor-pointer ${hidden('status')}" onclick="openSliderModal(${idx}, 'status')">${emp.status}</td>
                    <td class="p-1 text-center text-[9px] font-mono text-slate-400 ${hidden('soll')}">${empSoll.toFixed(0)}</td>
                    <td class="p-1 text-center text-[10px] font-black ${hidden('ist')}">${ist.toFixed(0)}</td>
                    <td class="p-1 text-center text-[9px] font-black ${diff>=0?'text-emerald-500':'text-rose-500'} ${hidden('diff')}">${diff.toFixed(0)}</td>
                    <td class="p-1 text-center text-[9px] font-black text-blue-500 cursor-pointer ${hidden('prev')}" onclick="openSliderModal(${idx}, 'prevOvertime')">${emp.prevOvertime}</td>
                    ${dHTML}
                </tr>`;
            });
            document.getElementById('tableBody').innerHTML = bodyHTML;
            renderTableFooter(visibleDays, dailyCounts, hidden);
            renderShiftPalette(); lucide.createIcons();
        }

        function renderTableFooter(days, counts, hidden) {
            const foot = document.getElementById('tableFoot'); foot.innerHTML = "";
            const codes = Object.keys(SHIFT_TYPES).filter(c => shiftCounterSettings[c] && c !== 'X');
            codes.forEach(sCode => {
                const sInfo = SHIFT_TYPES[sCode];
                let fHTML = `<tr class="bg-[var(--bg-color)]/95 border-t border-black/5 text-[9px] font-black">
                    <td class="p-2 sticky-left name-col-bg border-r border-black/5 flex items-center gap-2">
                        <div class="w-4 h-4 rounded ${sInfo.color} flex items-center justify-center text-[8px] ${sInfo.textColor}">${sCode}</div>
                        <span class="opacity-70 truncate">${sInfo.label}</span>
                    </td>
                    <td colspan="5" class="border-r border-black/5 ${hidden('status') && hidden('soll') && hidden('ist') && hidden('diff') && hidden('prev') ? 'hidden-col' : ''}"></td>`;
                days.forEach(day => {
                    const k = day.toISOString().split('T')[0];
                    fHTML += `<td class="p-1 text-center border-r border-black/5">${counts[k][sCode] || 0}</td>`;
                });
                foot.innerHTML += fHTML + `</tr>`;
            });
        }

        // --- Standard UI Interaction ---
        function handleCellClick(empId, dateKey, empName) {
            if (activeShift === 'NOTE') openNoteModal(empId, dateKey, empName);
            else { if (!roster[empId]) roster[empId] = {}; roster[empId][dateKey] = roster[empId][dateKey] === activeShift ? null : activeShift; renderRoster(); }
        }

        function openAddEmpOverlay() { document.getElementById('addEmpOverlay').style.display = 'flex'; }
        function closeAddEmpOverlay() { document.getElementById('addEmpOverlay').style.display = 'none'; }
        function addNewEmployee() {
            const n = document.getElementById('newEmpName').value;
            if(!n) return;
            EMPLOYEES.push({ id: Date.now().toString(), name: n, role: document.getElementById('newEmpRole').value || 'Pflege', status: document.getElementById('newEmpStatus').value+'%', prevOvertime: 0 });
            renderRoster(); closeAddEmpOverlay(); saveData();
            document.getElementById('newEmpName').value = '';
        }

        function openEditModal(i) { editingEmpIndex = i; document.getElementById('editEmpNameInput').value = EMPLOYEES[i].name; document.getElementById('editEmpRoleInput').value = EMPLOYEES[i].role; document.getElementById('editEmpOverlay').style.display = 'flex'; }
        function closeEditModal() { document.getElementById('editEmpOverlay').style.display = 'none'; }
        function applyEditEmployee() { EMPLOYEES[editingEmpIndex].name = document.getElementById('editEmpNameInput').value; EMPLOYEES[editingEmpIndex].role = document.getElementById('editEmpRoleInput').value; renderRoster(); closeEditModal(); saveData(); }
        function confirmDeleteEmployee() { if(confirm('Mitarbeiter wirklich löschen?')) { EMPLOYEES.splice(editingEmpIndex, 1); renderRoster(); closeEditModal(); saveData(); } }

        function openSliderModal(i, f) { editingEmpIndex = i; editingField = f; const s = document.getElementById('statusSlider'); s.value = f==='prevOvertime' ? EMPLOYEES[i].prevOvertime : parseInt(EMPLOYEES[i].status); document.getElementById('modalTitle').innerText = f==='status' ? 'VZ-Anteil' : 'Vormonat'; updateSliderLabel(); document.getElementById('modalOverlay').style.display = 'flex'; }
        function closeSliderModal() { document.getElementById('modalOverlay').style.display = 'none'; }
        function updateSliderLabel() { document.getElementById('sliderValueText').innerText = document.getElementById('statusSlider').value + (editingField==='status'?'%':'h'); }
        function applySliderValue() { const v = document.getElementById('statusSlider').value; if(editingField==='status') EMPLOYEES[editingEmpIndex].status = v+'%'; else EMPLOYEES[editingEmpIndex].prevOvertime = parseInt(v); renderRoster(); closeSliderModal(); saveData(); }

        function openNoteModal(empId, dateKey, empName) { noteTarget = { empId, dateKey }; document.getElementById('noteInput').value = (rosterNotes[empId] || {})[dateKey] || ""; document.getElementById('noteModalOverlay').style.display = 'flex'; }
        function closeNoteModal() { document.getElementById('noteModalOverlay').style.display = 'none'; }
        function saveNote() { if(!noteTarget) return; if(!rosterNotes[noteTarget.empId]) rosterNotes[noteTarget.empId] = {}; const val = document.getElementById('noteInput').value.trim(); if(!val) delete rosterNotes[noteTarget.empId][noteTarget.dateKey]; else rosterNotes[noteTarget.empId][noteTarget.dateKey] = val; renderRoster(); closeNoteModal(); saveData(); }

        function openColumnModal() {
            const colList = document.getElementById('columnToggleList'); colList.innerHTML = '';
            const labels = { status: 'VZ Anteil', soll: 'Soll Std', ist: 'Ist Std', diff: 'Diff +/-', prev: 'Vormonat' };
            Object.keys(labels).forEach(key => {
                const div = document.createElement('div'); div.className = "flex items-center justify-between p-2 bg-black/5 rounded-xl";
                div.innerHTML = `<span class="text-[11px] font-bold">${labels[key]}</span><button onclick="toggleColumn('${key}')" class="w-10 h-5 rounded-full relative transition-all ${viewSettings[key] ? 'bg-blue-600' : 'bg-slate-300'}"><div class="absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${viewSettings[key] ? 'right-1' : 'left-1'}"></div></button>`;
                colList.appendChild(div);
            });
            const shiftList = document.getElementById('shiftToggleList'); shiftList.innerHTML = '';
            Object.keys(SHIFT_TYPES).forEach(key => { if(key === 'X') return;
                const btn = document.createElement('button'); btn.onclick = () => toggleShiftCounter(key);
                btn.className = `px-3 py-1.5 rounded-xl text-[9px] font-black border transition-all ${shiftCounterSettings[key] ? 'bg-blue-600 text-white border-blue-500 scale-105' : 'bg-black/5 border-white/5 text-slate-500'}`;
                btn.innerText = key; shiftList.appendChild(btn);
            });
            document.getElementById('columnOverlay').style.display = 'flex';
        }
        function closeColumnModal() { document.getElementById('columnOverlay').style.display = 'none'; }
        function toggleColumn(key) { viewSettings[key] = !viewSettings[key]; localStorage.setItem('helios_view_settings', JSON.stringify(viewSettings)); openColumnModal(); renderRoster(); }
        function toggleShiftCounter(key) { shiftCounterSettings[key] = !shiftCounterSettings[key]; localStorage.setItem('helios_counter_settings', JSON.stringify(shiftCounterSettings)); openColumnModal(); renderRoster(); }

        function openShiftModal() { renderShiftTypeList(); document.getElementById('shiftModalOverlay').style.display = 'flex'; }
        function closeShiftModal() { document.getElementById('shiftModalOverlay').style.display = 'none'; }
        function renderShiftTypeList() {
            const container = document.getElementById('shiftTypeListContainer'); container.innerHTML = '';
            Object.entries(SHIFT_TYPES).forEach(([k, v]) => { if(k==='X') return;
                const div = document.createElement('div'); div.className = "flex items-center gap-3 bg-white/5 p-3 rounded-xl border border-white/5";
                div.innerHTML = `<div class="w-10 h-10 rounded-lg ${v.color} flex items-center justify-center font-black ${v.textColor}">${k}</div><div class="flex-1"><input type="text" value="${v.label}" onchange="SHIFT_TYPES['${k}'].label=this.value" class="w-full bg-black/10 text-[11px] font-bold px-2 py-1 rounded outline-none"></div><div class="w-20"><input type="number" step="0.1" value="${v.hours}" onchange="SHIFT_TYPES['${k}'].hours=parseFloat(this.value)" class="w-full bg-black/10 text-[11px] font-bold px-2 py-1 rounded text-center outline-none"></div>`;
                container.appendChild(div);
            });
        }

        function renderShiftPalette() {
            const c = document.getElementById('shiftPalette'); c.innerHTML = `<button onclick="activeShift='NOTE'; renderShiftPalette()" class="flex items-center p-1.5 rounded-xl border transition-all ${activeShift==='NOTE'?'bg-yellow-500/20 border-yellow-500 scale-105 shadow-lg':'bg-black/5 border-white/5'}"><div class="w-8 h-8 rounded-lg bg-yellow-500 flex items-center justify-center shadow-md"><i data-lucide="sticky-note" size="14"></i></div></button>`;
            Object.entries(SHIFT_TYPES).forEach(([k, v]) => {
                const b = document.createElement('button'); b.onclick = () => { activeShift = k; renderShiftPalette(); };
                b.className = `flex items-center gap-2 p-1.5 rounded-xl border transition-all ${activeShift===k?'bg-blue-500/20 border-blue-500 scale-105 shadow-lg':'bg-black/5 border-white/5'}`;
                b.innerHTML = `<div class="w-8 h-8 rounded-lg ${v.color} flex items-center justify-center font-black ${v.textColor} shadow-md">${k}</div>`;
                c.appendChild(b);
            }); lucide.createIcons();
        }

        function exportToPDF() {
            const oldMode = viewMode; viewMode = 'month'; renderRoster();
            document.getElementById('printMonthLabel').innerText = currentDate.toLocaleString('de-DE', { month: 'long', year: 'numeric' });
            setTimeout(() => { window.print(); viewMode = oldMode; renderRoster(); }, 500);
        }

        function adjustZoom(delta) { 
            const slider = document.getElementById('zoomSlider'); 
            let val = delta === 0 ? parseFloat(slider.value) : parseFloat(slider.value) + delta; 
            val = Math.max(0.5, Math.min(1.5, val)); 
            slider.value = val; 
            document.documentElement.style.setProperty('--zoom-factor', val); 
            document.getElementById('zoomText').innerText = Math.round(val * 100) + '%'; 
        }

        function openYearModal() { document.getElementById('yearDisplay').innerText = currentDate.getFullYear(); renderMonthGrid(); document.getElementById('yearViewOverlay').style.display = 'flex'; }
        function closeYearModal() { document.getElementById('yearViewOverlay').style.display = 'none'; }
        function renderMonthGrid() { const container = document.getElementById('monthGrid'); container.innerHTML = ''; const months = ["Jan", "Feb", "Mär", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dez"]; months.forEach((m, i) => { const btn = document.createElement('button'); const isCurrent = currentDate.getMonth() === i; btn.className = `p-3 rounded-xl text-[9px] font-black uppercase transition-all border ${isCurrent ? 'bg-blue-600 text-white shadow-lg' : 'bg-black/5 text-current'}`; btn.innerText = m; btn.onclick = () => { currentDate.setMonth(i); renderRoster(); closeYearModal(); }; container.appendChild(btn); }); }
        function changeYear(o) { currentDate.setFullYear(currentDate.getFullYear() + o); document.getElementById('yearDisplay').innerText = currentDate.getFullYear(); renderMonthGrid(); }
        function showToast(m, i) { const t = document.getElementById('toast'); document.getElementById('toastMessage').innerText = m; const iconEl = document.getElementById('toastIcon'); iconEl.innerHTML = `<i data-lucide="${i}"></i>`; lucide.createIcons(); t.style.display = 'flex'; setTimeout(()=>t.style.display='none', 3000); }
        function calculateWorkingDays(y, m) { let c = 0; const d = new Date(y, m, 1); while (d.getMonth() === m) { if (d.getDay() !== 0 && d.getDay() !== 6) c++; d.setDate(d.getDate() + 1); } return c; }

        window.onload = async () => { 
            await initFirebase(); 
            if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
            renderRoster(); 
            updateViewButtons(); 
        };
    </script>
</body>
</html>
