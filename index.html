<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dienstplan Pro - Helios Notaufnahme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseCore = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, onSnapshot, serverTimestamp };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #020617;
            --text-primary: #ffffff; 
            --text-secondary: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent: #3b82f6;
            --holiday-color: rgba(234, 179, 8, 0.15);
            --weekend-color: rgba(59, 130, 246, 0.08);
            --zoom-factor: 1;
        }

        .light-mode {
            --bg-color: #f8fafc;
            --text-primary: #0f172a; 
            --text-secondary: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.8); 
            --glass-border: rgba(15, 23, 42, 0.1);
            --holiday-color: rgba(234, 179, 8, 0.1);
            --weekend-color: rgba(59, 130, 246, 0.05);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            transition: background 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .glass { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); }
        .sticky-left { position: sticky; left: 0; z-index: 40; background: var(--bg-color); }
        .holiday-cell { background-color: var(--holiday-color) !important; }
        .weekend-cell { background-color: var(--weekend-color) !important; }
        
        #rosterTable { zoom: var(--zoom-factor); border-collapse: separate; border-spacing: 0; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.2); border-radius: 10px; }

        .note-indicator { position: absolute; top: 2px; right: 2px; width: 4px; height: 4px; border-radius: 50%; background: #eab308; }
        
        @keyframes pulse-sync {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        .syncing { animation: pulse-sync 1.5s infinite; }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; }
            .glass { border: none !important; background: transparent !important; box-shadow: none !important; }
            .sticky-left { position: relative !important; background: white !important; }
            #rosterTable { zoom: 0.8 !important; width: 100% !important; }
            th, td { border: 0.5pt solid #ccc !important; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Toast / Notification -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[300] hidden pointer-events-none">
        <div class="glass px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 border-white/20">
            <div id="toastIcon" class="text-blue-500"></div>
            <span id="toastMessage" class="text-sm font-bold text-current"></span>
        </div>
    </div>

    <!-- Modals -->
    <div id="overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden items-center justify-center p-4">
        <div id="modalContent" class="glass p-8 rounded-3xl w-full max-w-md shadow-2xl transition-all scale-95 opacity-0"></div>
    </div>

    <!-- Header -->
    <header class="glass m-4 p-3 rounded-2xl flex items-center justify-between gap-4 no-print">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                <i data-lucide="shield-check" class="text-white" size="20"></i>
            </div>
            <div>
                <h1 class="text-sm font-black tracking-tight leading-none uppercase">Helios Duisburg</h1>
                <p id="syncLabel" class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mt-1">Initialisiere...</p>
            </div>
        </div>

        <div class="flex items-center gap-2 bg-black/10 p-1 rounded-xl">
            <button onclick="changeMonth(-1)" class="p-2 hover:bg-white/5 rounded-lg transition-colors"><i data-lucide="chevron-left" size="16"></i></button>
            <button onclick="openYearPicker()" id="currentMonthLabel" class="px-4 text-[11px] font-black uppercase tracking-tighter">Monat</button>
            <button onclick="changeMonth(1)" class="p-2 hover:bg-white/5 rounded-lg transition-colors"><i data-lucide="chevron-right" size="16"></i></button>
        </div>

        <div class="flex items-center gap-2">
            <button id="lockBtn" onclick="toggleLock()" class="p-2.5 bg-slate-800 rounded-xl transition-all border border-white/5">
                <i data-lucide="lock" id="lockIcon" size="18"></i>
            </button>
            <button onclick="openSettings()" class="p-2.5 bg-slate-800 rounded-xl border border-white/5"><i data-lucide="settings" size="18"></i></button>
            <button onclick="exportPlan()" class="hidden md:flex items-center gap-2 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-xl text-[11px] font-black transition-all shadow-lg shadow-blue-600/20">
                <i data-lucide="file-text" size="14"></i> EXPORT
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden px-4 pb-4 gap-4">
        <!-- Sidebar Palette -->
        <aside id="palette" class="w-20 lg:w-48 flex flex-col gap-2 no-print transition-all duration-300 opacity-30 pointer-events-none">
            <div class="glass rounded-2xl p-3 flex-1 overflow-y-auto no-scrollbar flex flex-col gap-2" id="paletteContent"></div>
        </aside>

        <!-- Main Roster -->
        <main class="flex-1 glass rounded-3xl overflow-hidden flex flex-col relative shadow-inner">
            <div class="overflow-auto flex-1 custom-scrollbar" id="scrollContainer">
                <table id="rosterTable" class="w-full">
                    <thead id="tableHead" class="sticky top-0 z-50 bg-[var(--bg-color)]"></thead>
                    <tbody id="tableBody"></tbody>
                    <tfoot id="tableFoot" class="sticky bottom-0 z-40"></tfoot>
                </table>
            </div>
        </main>
    </div>

    <script type="module">
        // --- Firebase State ---
        let db, auth, user, firebaseApp;
        const appId = typeof __app_id !== 'undefined' ? __app_id : "helios-notaufnahme-duisburg";

        let isLocked = true;
        let currentDate = new Date(2026, 3, 1);
        let activeShift = 'FD';

        // --- Die Mannschaft von Henne ---
        const INITIAL_EMPLOYEES = [
            { id: '1', name: 'Adams, Hendrik', role: 'Stationsleitung' },
            { id: '2', name: 'Fuchsa, Jennifer', role: 'stellv. Leitung' },
            { id: '3', name: 'Günter, Stephanie', role: 'Pflegekraft' },
            { id: '4', name: 'Blank, Alexandra', role: 'Pflegekraft' },
            { id: '5', name: 'Friedrich, Kristina', role: 'Pflegekraft' },
            { id: '6', name: 'Weienberg, Hanna', role: 'Fachkraft' },
            { id: '7', name: 'Hackmann, Matthias', role: 'Pflegekraft' },
            { id: '8', name: 'Buchmüller, Jörg', role: 'Pflegekraft' },
            { id: '9', name: 'Rösken, Katrin', role: 'Pflegekraft' },
            { id: '10', name: 'Theißen, Jennifer', role: 'Pflegekraft' },
            { id: '11', name: 'Daniels, Justin', role: 'Pflegekraft' },
            { id: '12', name: 'Kaymaz, Melda', role: 'Pflegekraft' },
            { id: '13', name: 'Kühn, Philipp', role: 'Pflegekraft' },
            { id: '14', name: 'Strachanski, Julia', role: 'Pflegekraft' },
            { id: '15', name: 'Preußner, Pauline', role: 'Azubi' },
            { id: '16', name: 'Bielok, Lara', role: 'Pflegekraft' },
            { id: '17', name: 'Wüstkamp, Bianca', role: 'Pflegekraft' },
            { id: '18', name: 'Bondzau, Martina', role: 'Pflegekraft' }
        ];

        // Local State Management
        let employees = JSON.parse(localStorage.getItem('h_emp')) || INITIAL_EMPLOYEES;
        let roster = JSON.parse(localStorage.getItem('h_rost')) || {};
        let notes = JSON.parse(localStorage.getItem('h_notes')) || {};
        
        // Display Settings
        let viewSettings = JSON.parse(localStorage.getItem('h_view')) || { role: true };
        let counterSettings = JSON.parse(localStorage.getItem('h_counters')) || { FD: true, SD: true, ND: true, ZD: true };
        
        const SHIFTS = {
            FD: { label: 'Frühdienst', color: 'bg-cyan-500', text: 'text-white', h: 7.7 },
            SD: { label: 'Spätdienst', color: 'bg-fuchsia-600', text: 'text-white', h: 7.7 },
            ND: { label: 'Nachtdienst', color: 'bg-indigo-600', text: 'text-white', h: 9.5 },
            ZD: { label: 'Zwischendienst', color: 'bg-blue-500', text: 'text-white', h: 7.7 },
            U:  { label: 'Urlaub', color: 'bg-yellow-500', text: 'text-black', h: 7.7 },
            K:  { label: 'Krank', color: 'bg-rose-500', text: 'text-white', h: 7.7 },
            LT: { label: 'Leitungstag', color: 'bg-emerald-500', text: 'text-white', h: 7.7 },
            F:  { label: 'Frei', color: 'bg-slate-700/50', text: 'text-slate-400', h: 0 }
        };

        // --- Firebase Core Logic ---
        async function initFirebase() {
            if (!window.firebaseCore) {
                showToast("Firebase nicht geladen", "alert-circle");
                return;
            }

            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, onAuthStateChanged } = window.firebaseCore;

            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : { apiKey: "", authDomain: "", projectId: "" };

                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };

                await initAuth();

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (u) {
                        document.getElementById('syncLabel').innerText = "Sync: Online";
                        loadCloudData();
                    } else {
                        document.getElementById('syncLabel').innerText = "Sync: Offline";
                    }
                });
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                showToast("Auth Fehler: " + error.code, "alert-circle");
            }
        }

        async function loadCloudData() {
            if (!user || !db) return;
            const { doc, getDoc } = window.firebaseCore;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rosterPlan', 'main');
            
            try {
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.employees && data.employees.length > 0) employees = data.employees;
                    if (data.roster) roster = data.roster;
                    if (data.notes) notes = data.notes;
                    renderRoster();
                }
            } catch (e) {
                console.error("Ladefehler:", e);
                showToast("Cloud-Sync fehlgeschlagen", "alert-triangle");
            }
        }

        async function saveToCloud() {
            if (!user || !db) return;
            const { doc, setDoc, serverTimestamp } = window.firebaseCore;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rosterPlan', 'main');
            
            document.getElementById('syncLabel').classList.add('syncing');
            try {
                await setDoc(docRef, {
                    employees, 
                    roster, 
                    notes,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                showToast("Änderungen gesichert", "check");
            } catch (e) {
                console.error("Speicherfehler:", e);
                showToast("Sync-Fehler", "alert-triangle");
            }
            setTimeout(() => document.getElementById('syncLabel').classList.remove('syncing'), 1000);
        }

        // --- App Interface Logic ---
        async function init() {
            await initFirebase();
            renderPalette();
            renderRoster();
            lucide.createIcons();
        }

        window.toggleLock = () => {
            isLocked = !isLocked;
            const btn = document.getElementById('lockBtn');
            const icon = document.getElementById('lockIcon');
            const palette = document.getElementById('palette');

            if (isLocked) {
                btn.className = "p-2.5 bg-slate-800 rounded-xl transition-all border border-white/5";
                icon.setAttribute('data-lucide', 'lock');
                palette.classList.add('opacity-30', 'pointer-events-none');
            } else {
                btn.className = "p-2.5 bg-emerald-600 rounded-xl transition-all border border-emerald-400 shadow-lg shadow-emerald-600/20";
                icon.setAttribute('data-lucide', 'lock-open');
                palette.classList.remove('opacity-30', 'pointer-events-none');
                showToast("Editor bereit", "pencil");
            }
            lucide.createIcons();
            renderRoster();
        };

        function getDaysInMonth(y, m) {
            const days = [];
            const date = new Date(y, m, 1);
            while (date.getMonth() === m) {
                days.push(new Date(date));
                date.setDate(date.getDate() + 1);
            }
            return days;
        }

        window.changeMonth = (delta) => {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderRoster();
        };

        function renderPalette() {
            const container = document.getElementById('paletteContent');
            container.innerHTML = `<p class="text-[9px] font-black text-slate-500 uppercase tracking-widest text-center mb-2">Dienstwahl</p>`;
            
            Object.entries(SHIFTS).forEach(([key, cfg]) => {
                const btn = document.createElement('button');
                btn.onclick = () => { activeShift = key; renderPalette(); };
                btn.className = `w-full aspect-square md:aspect-auto md:h-12 rounded-xl flex items-center justify-center font-black transition-all border-2 ${activeShift === key ? `${cfg.color} ${cfg.text} border-white shadow-xl scale-105` : `bg-black/20 border-transparent text-slate-400 hover:border-white/10`}`;
                btn.innerHTML = `<span class="text-xs">${key}</span>`;
                container.appendChild(btn);
            });

            const noteBtn = document.createElement('button');
            noteBtn.onclick = () => { activeShift = 'NOTE'; renderPalette(); };
            noteBtn.className = `w-full h-12 mt-4 rounded-xl flex items-center justify-center transition-all border-2 ${activeShift === 'NOTE' ? 'bg-yellow-500 text-black border-white' : 'bg-black/20 border-transparent text-yellow-500/50'}`;
            noteBtn.innerHTML = `<i data-lucide="sticky-note" size="18"></i>`;
            container.appendChild(noteBtn);
            lucide.createIcons();
        }

        function renderRoster() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const days = getDaysInMonth(year, month);
            
            document.getElementById('currentMonthLabel').innerText = currentDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });

            // Table Head
            let headHTML = `<tr><th class="p-4 text-left text-[10px] font-black uppercase tracking-widest sticky-left border-b border-white/5 min-w-[180px]">Personal</th>`;
            days.forEach(d => {
                const isW = d.getDay() === 0 || d.getDay() === 6;
                headHTML += `<th class="p-2 border-b border-white/5 min-w-[38px] ${isW ? 'weekend-cell' : ''}">
                    <div class="flex flex-col items-center">
                        <span class="text-[8px] uppercase opacity-40 font-bold">${d.toLocaleDateString('de-DE', { weekday: 'short' })}</span>
                        <span class="text-[11px] font-black">${d.getDate()}</span>
                    </div>
                </th>`;
            });
            document.getElementById('tableHead').innerHTML = headHTML + `</tr>`;

            // Table Body
            let bodyHTML = "";
            employees.forEach((emp, eIdx) => {
                let row = `<tr class="group hover:bg-white/5 transition-colors">
                    <td class="p-3 sticky-left border-b border-white/5 z-20">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-slate-700 to-slate-900 flex items-center justify-center text-[10px] font-bold text-slate-400">
                                ${emp.name ? emp.name.split(',')[0].substring(0,2).toUpperCase() : '??'}
                            </div>
                            <div class="flex flex-col overflow-hidden">
                                <span class="text-[11px] font-bold truncate uppercase tracking-tighter">${emp.name}</span>
                                ${viewSettings.role ? `<span class="text-[9px] text-slate-500 font-medium">${emp.role}</span>` : ''}
                            </div>
                            ${!isLocked ? `<button onclick="editEmployee(${eIdx})" class="ml-auto opacity-0 group-hover:opacity-100 p-1 text-slate-500"><i data-lucide="more-vertical" size="14"></i></button>` : ''}
                        </div>
                    </td>`;

                days.forEach(d => {
                    const k = d.toISOString().split('T')[0];
                    const shiftKey = (roster[emp.id] || {})[k];
                    const hasNote = (notes[emp.id] || {})[k];
                    const cfg = SHIFTS[shiftKey];
                    const isW = d.getDay() === 0 || d.getDay() === 6;

                    row += `<td onclick="handleCellClick('${emp.id}', '${k}')" class="p-0.5 border-b border-white/5 text-center transition-all relative ${isW ? 'weekend-cell' : ''} ${!isLocked ? 'cursor-pointer hover:bg-blue-500/10' : ''}">
                        <div class="w-full h-8 flex items-center justify-center rounded-lg text-[10px] font-black transition-all ${cfg ? `${cfg.color} ${cfg.text} shadow-lg scale-95` : ''}">
                            ${shiftKey || ''}
                            ${hasNote ? `<div class="note-indicator"></div>` : ''}
                        </div>
                    </td>`;
                });
                bodyHTML += row + `</tr>`;
            });
            
            if (!isLocked) {
                bodyHTML += `<tr><td colspan="${days.length + 1}" class="p-4"><button onclick="addEmployee()" class="w-full py-2 rounded-xl border border-dashed border-white/10 text-[10px] font-black text-slate-500 hover:text-white hover:border-white/30 transition-all">+ WEITERES PERSONAL HINZUFÜGEN</button></td></tr>`;
            }

            document.getElementById('tableBody').innerHTML = bodyHTML;
            renderFooter(days);
            lucide.createIcons();
        }

        function renderFooter(days) {
            const foot = document.getElementById('tableFoot');
            foot.innerHTML = "";
            
            Object.keys(counterSettings).forEach(sKey => {
                if (!counterSettings[sKey]) return;
                const cfg = SHIFTS[sKey];
                let row = `<tr class="bg-[var(--bg-color)]/90 backdrop-blur-md">
                    <td class="p-2 sticky-left border-t border-white/5 text-[10px] font-bold">
                        <div class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded ${cfg.color} ${cfg.text} flex items-center justify-center text-[8px]">${sKey}</div>
                            <span class="opacity-60 uppercase tracking-tighter">${cfg.label}</span>
                        </div>
                    </td>`;
                
                days.forEach(d => {
                    const k = d.toISOString().split('T')[0];
                    let count = 0;
                    employees.forEach(emp => {
                        if ((roster[emp.id] || {})[k] === sKey) count++;
                    });
                    row += `<td class="p-1 text-center border-t border-white/5 text-[10px] font-black ${count > 0 ? 'text-white' : 'opacity-20'}">${count || 0}</td>`;
                });
                foot.innerHTML += row + `</tr>`;
            });
        }

        window.handleCellClick = (empId, date) => {
            if (isLocked) return;
            if (activeShift === 'NOTE') {
                openNoteEditor(empId, date);
                return;
            }
            if (!roster[empId]) roster[empId] = {};
            if (roster[empId][date] === activeShift) {
                delete roster[empId][date];
            } else {
                roster[empId][date] = activeShift;
            }
            renderRoster();
            saveToCloud();
        };

        // --- Settings Modal ---
        window.openSettings = () => {
            showModal(`
                <h3 class="text-xl font-black mb-6 uppercase tracking-tight">Einstellungen</h3>
                <div class="space-y-6">
                    <div>
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">Anzeige</p>
                        <div class="flex items-center justify-between p-3 bg-black/20 rounded-xl border border-white/5">
                            <span class="text-xs font-bold">Rollen/Positionen anzeigen</span>
                            <button onclick="toggleViewSetting('role')" class="w-10 h-6 rounded-full relative transition-all ${viewSettings.role ? 'bg-blue-600' : 'bg-slate-700'}">
                                <div class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${viewSettings.role ? 'right-1' : 'left-1'}"></div>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">Fußzeilen-Zähler</p>
                        <div class="grid grid-cols-4 gap-2">
                            ${Object.keys(SHIFTS).filter(k => k !== 'F').map(k => `
                                <button onclick="toggleCounter('${k}')" class="p-2 rounded-xl border transition-all text-[10px] font-black ${counterSettings[k] ? 'bg-blue-600 border-white text-white' : 'bg-black/20 border-white/5 text-slate-500'}">
                                    ${k}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="pt-4 flex flex-col gap-2">
                        <button onclick="toggleTheme()" class="w-full py-3 bg-slate-800 rounded-xl text-xs font-bold border border-white/5">Design wechseln (Light/Dark)</button>
                        <button onclick="closeModal()" class="w-full py-4 bg-blue-600 rounded-xl text-sm font-black text-white shadow-lg">FERTIG</button>
                    </div>
                </div>
            `);
        };

        window.toggleViewSetting = (key) => {
            viewSettings[key] = !viewSettings[key];
            localStorage.setItem('h_view', JSON.stringify(viewSettings));
            openSettings();
            renderRoster();
        };

        window.toggleCounter = (key) => {
            counterSettings[key] = !counterSettings[key];
            localStorage.setItem('h_counters', JSON.stringify(counterSettings));
            openSettings();
            renderRoster();
        };

        window.toggleTheme = () => {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        };

        // --- Year Picker ---
        window.openYearPicker = () => {
            renderMonthGrid();
        };

        function renderMonthGrid() {
            const year = currentDate.getFullYear();
            const months = ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
            
            showModal(`
                <h3 class="text-xl font-black mb-6 text-center uppercase tracking-tight flex items-center justify-between">
                    <button onclick="changeYear(-1)" class="p-2 hover:bg-white/5 rounded-lg"><i data-lucide="chevron-left"></i></button>
                    ${year}
                    <button onclick="changeYear(1)" class="p-2 hover:bg-white/5 rounded-lg"><i data-lucide="chevron-right"></i></button>
                </h3>
                <div class="grid grid-cols-3 gap-2">
                    ${months.map((m, i) => `
                        <button onclick="selectMonth(${i})" class="p-3 rounded-xl border transition-all text-[10px] font-black uppercase ${currentDate.getMonth() === i ? 'bg-blue-600 border-white text-white shadow-lg' : 'bg-black/20 border-white/5 text-slate-400'}">
                            ${m.substring(0,3)}
                        </button>
                    `).join('')}
                </div>
                <button onclick="closeModal()" class="w-full mt-6 py-4 bg-slate-800 rounded-xl text-xs font-bold border border-white/5 text-white">SCHLIESSEN</button>
            `);
        }

        window.changeYear = (delta) => {
            currentDate.setFullYear(currentDate.getFullYear() + delta);
            renderMonthGrid();
        };

        window.selectMonth = (m) => {
            currentDate.setMonth(m);
            closeModal();
            renderRoster();
        };

        // --- Standard Modals ---
        function showModal(html) {
            const overlay = document.getElementById('overlay');
            const content = document.getElementById('modalContent');
            content.innerHTML = html;
            overlay.style.display = 'flex';
            setTimeout(() => content.classList.remove('scale-95', 'opacity-0'), 10);
            lucide.createIcons();
        }

        window.closeModal = () => {
            const content = document.getElementById('modalContent');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => document.getElementById('overlay').style.display = 'none', 200);
        };

        window.addEmployee = () => {
            showModal(`
                <h3 class="text-xl font-black mb-6 flex items-center gap-2 uppercase tracking-tight">Neuer Mitarbeiter</h3>
                <div class="space-y-4">
                    <input type="text" id="new_name" placeholder="Name, Vorname" class="w-full bg-black/20 border border-white/10 rounded-xl p-4 text-sm focus:outline-none focus:border-blue-500 transition-all text-white">
                    <input type="text" id="new_role" placeholder="Position" class="w-full bg-black/20 border border-white/10 rounded-xl p-4 text-sm focus:outline-none focus:border-blue-500 transition-all text-white">
                    <div class="flex gap-2 pt-4">
                        <button onclick="closeModal()" class="flex-1 py-4 text-sm font-bold opacity-50 text-white">Abbrechen</button>
                        <button onclick="saveNewEmployee()" class="flex-1 py-4 bg-blue-600 rounded-xl text-sm font-black shadow-lg text-white">SPEICHERN</button>
                    </div>
                </div>
            `);
        };

        window.saveNewEmployee = () => {
            const name = document.getElementById('new_name').value;
            const role = document.getElementById('new_role').value;
            if (!name) return;
            employees.push({ id: crypto.randomUUID(), name, role });
            closeModal();
            renderRoster();
            saveToCloud();
        };

        window.editEmployee = (idx) => {
            const emp = employees[idx];
            showModal(`
                <h3 class="text-xl font-black mb-6 uppercase tracking-tight">Bearbeiten</h3>
                <div class="space-y-4">
                    <input type="text" id="edit_name" value="${emp.name}" class="w-full bg-black/20 border border-white/10 rounded-xl p-4 text-sm text-white">
                    <input type="text" id="edit_role" value="${emp.role}" class="w-full bg-black/20 border border-white/10 rounded-xl p-4 text-sm text-white">
                    <div class="flex flex-col gap-2 pt-4">
                        <button onclick="updateEmployee(${idx})" class="w-full py-4 bg-blue-600 rounded-xl text-sm font-black text-white">UPDATE</button>
                        <button onclick="deleteEmployee(${idx})" class="w-full py-2 text-[10px] font-black text-rose-500 mt-4 border border-rose-500/20 rounded-xl">LÖSCHEN</button>
                        <button onclick="closeModal()" class="w-full py-2 text-xs font-bold opacity-40 text-white">Schließen</button>
                    </div>
                </div>
            `);
        };

        window.updateEmployee = (idx) => {
            employees[idx].name = document.getElementById('edit_name').value;
            employees[idx].role = document.getElementById('edit_role').value;
            closeModal();
            renderRoster();
            saveToCloud();
        };

        window.deleteEmployee = (idx) => {
            if (confirm("Mitarbeiter wirklich löschen?")) {
                employees.splice(idx, 1);
                closeModal();
                renderRoster();
                saveToCloud();
            }
        };

        function openNoteEditor(empId, date) {
            const currentNote = (notes[empId] || {})[date] || "";
            showModal(`
                <h3 class="text-xl font-black mb-2 flex items-center gap-2 uppercase"><i data-lucide="sticky-note" class="text-yellow-500"></i> Notiz</h3>
                <p class="text-[10px] text-slate-500 mb-6 uppercase font-bold tracking-widest">${date}</p>
                <textarea id="note_text" class="w-full bg-black/20 border border-white/10 rounded-2xl p-4 text-sm h-32 focus:outline-none resize-none text-white">${currentNote}</textarea>
                <div class="flex gap-2 pt-4">
                    <button onclick="closeModal()" class="flex-1 py-4 text-sm font-bold opacity-50 text-white">Abbrechen</button>
                    <button onclick="saveNote('${empId}', '${date}')" class="flex-1 py-4 bg-yellow-600 text-black rounded-xl text-sm font-black shadow-lg">SPEICHERN</button>
                </div>
            `);
        }

        window.saveNote = (empId, date) => {
            const text = document.getElementById('note_text').value.trim();
            if (!notes[empId]) notes[empId] = {};
            if (text) notes[empId][date] = text;
            else delete notes[empId][date];
            closeModal();
            renderRoster();
            saveToCloud();
        };

        function showToast(msg, icon) {
            const t = document.getElementById('toast');
            document.getElementById('toastMessage').innerText = msg;
            document.getElementById('toastIcon').innerHTML = `<i data-lucide="${icon}"></i>`;
            lucide.createIcons();
            t.style.display = 'flex';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        window.exportPlan = () => window.print();

        window.onload = init;
    </script>
</body>
</html>
