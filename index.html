import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from 'firebase/firestore';
import { 
  Users, Calendar, ChevronLeft, ChevronRight, Clock, Sun, Moon, Coffee, 
  XCircle, Plane, Printer, Save, Info, BookOpen, AlertTriangle, Lock, 
  Unlock, Maximize, Minimize, Cloud, FileText, Settings, Search, Layout,
  Trash2, UserPlus, GripVertical, StickyNote, Palette, ListFilter,
  Monitor, Smartphone, X, Edit3, Check
} from 'lucide-react';

/**
 * --- HINWEIS FÜR GITHUB / LOKALE ENTWICKLUNG ---
 * Für die lokale Entwicklung kannst du das folgende Objekt mit deinen Daten füllen:
 * const firebaseConfig = { apiKey: "...", ... };
 * * Hier nutzen wir die Systemvariable, damit die Vorschau direkt funktioniert.
 */
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Die App-ID für die Datenbank-Pfade
const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'helios-notaufnahme-duisburg';

// --- Hilfslogik für NRW-Feiertage ---
const getHolidaysNRW = (year) => {
  const f = Math.floor, G = year % 19, C = f(year / 100), H = (C - f(C / 4) - f((8 * C + 13) / 25) + 19 * G + 15) % 30, 
        I = H - f(H / 28) * (1 - f(29 / (H + 1)) * f((21 - G) / 11)), 
        J = (year + f(year / 4) + I + 2 - C + f(C / 4)) % 7, 
        L = I - J, month = 3 + f((L + 40) / 44), day = L + 28 - 31 * f(month / 4);
  const easter = new Date(year, month - 1, day);
  const add = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r.toISOString().split('T')[0]; };
  return {
    [`${year}-01-01`]: "Neujahr", [add(easter, -2)]: "Karfreitag", [add(easter, 1)]: "Ostermontag",
    [`${year}-05-01`]: "Tag der Arbeit", [add(easter, 39)]: "Christi Himmelfahrt",
    [add(easter, 50)]: "Pfingstmontag", [add(easter, 60)]: "Fronleichnam",
    [`${year}-10-03`]: "Tag der Dt. Einheit", [`${year}-11-01`]: "Allerheiligen",
    [`${year}-12-25`]: "1. Weihnachtstag", [`${year}-12-26`]: "2. Weihnachtstag"
  };
};

const INITIAL_EMPLOYEES = [
  { id: '1', name: 'Adams, Hendrik', role: 'Stationsleitung', status: '100%', prevOvertime: 0 },
  { id: '2', name: 'Fuchsa, Jennifer', role: 'stellv. Leitung', status: '100%', prevOvertime: 0 },
  { id: '3', name: 'Günter, Stephanie', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
  { id: '4', name: 'Blank, Alexandra', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
  { id: '5', name: 'Friedrich, Kristina', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
  { id: '6', name: 'Weienberg, Hanna', role: 'Fachkraft', status: '100%', prevOvertime: 0 },
  { id: '7', name: 'Hackmann, Matthias', role: 'Pflegekraft', status: '90%', prevOvertime: 0 },
  { id: '8', name: 'Buchmüller, Jörg', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
  { id: '9', name: 'Rösken, Katrin', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
  { id: '10', name: 'Theißen, Jennifer', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
  { id: '11', name: 'Daniels, Justin', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
  { id: '12', name: 'Kaymaz, Melda', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
  { id: '13', name: 'Kühn, Philipp', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
  { id: '14', name: 'Strachanski, Julia', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
  { id: '15', name: 'Preußner, Pauline', role: 'Azubi', status: '100%', prevOvertime: 0 },
  { id: '16', name: 'Bielok, Lara', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
  { id: '17', name: 'Wüstkamp, Bianca', role: 'Pflegekraft', status: '100%', prevOvertime: 0 },
  { id: '18', name: 'Bondzau, Martina', role: 'Pflegekraft', status: '100%', prevOvertime: 0 }
];

const DEFAULT_SHIFTS = {
  FD: { label: 'Frühdienst', color: 'bg-cyan-400', textColor: 'text-cyan-950', hours: 7.7 },
  SD: { label: 'Spätdienst', color: 'bg-fuchsia-500', textColor: 'text-white', hours: 7.7 },
  ZD: { label: 'Zwischendienst', color: 'bg-indigo-500', textColor: 'text-white', hours: 7.7 },
  ND: { label: 'Nachtdienst', color: 'bg-orange-600', textColor: 'text-white', hours: 9.5 },
  U:  { label: 'Urlaub', color: 'bg-yellow-400', textColor: 'text-yellow-950', hours: 7.7 },
  K:  { label: 'Krank', color: 'bg-rose-500', textColor: 'text-white', hours: 7.7 },
  LT: { label: 'Leitungstag', color: 'bg-emerald-400', textColor: 'text-emerald-950', hours: 7.7 },
  X:  { label: 'Frei', color: 'bg-white/10', textColor: 'text-slate-500', hours: 0 }
};

const App = () => {
  const [user, setUser] = useState(null);
  const [employees, setEmployees] = useState(INITIAL_EMPLOYEES);
  const [roster, setRoster] = useState({});
  const [notes, setNotes] = useState({});
  const [shifts, setShifts] = useState(DEFAULT_SHIFTS);
  const [shiftOrder, setShiftOrder] = useState(Object.keys(DEFAULT_SHIFTS));
  const [columnOrder, setColumnOrder] = useState(['status', 'soll', 'ist', 'diff', 'prev']);
  const [currentDate, setCurrentDate] = useState(new Date(2026, 3, 1));
  const [activeShift, setActiveShift] = useState('FD');
  const [isEditMode, setIsEditMode] = useState(false);
  const [isInfoOpen, setIsInfoOpen] = useState(false);
  const [isYearOpen, setIsYearOpen] = useState(false);
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [viewMode, setViewMode] = useState('month'); 
  const [zoom, setZoom] = useState(1);
  const [isDarkMode, setIsDarkMode] = useState(true);
  const [isSyncing, setIsSyncing] = useState(false);
  const [dragItem, setDragItem] = useState(null);

  // --- Authentifizierung ---
  useEffect(() => {
    const performAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) { console.error("Auth Fehler:", e); }
    };
    performAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- Echtzeit-Sync ---
  useEffect(() => {
    if (!user) return;
    const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'rosterPlan', 'main');
    const unsub = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        if (data.employees) setEmployees(data.employees);
        if (data.roster) setRoster(data.roster);
        if (data.notes) setNotes(data.notes);
        if (data.shifts) setShifts(data.shifts);
        if (data.shiftOrder) setShiftOrder(data.shiftOrder);
        if (data.columnOrder) setColumnOrder(data.columnOrder);
      }
    });
    return () => unsub();
  }, [user]);

  const saveToCloud = async () => {
    if (!user) return;
    setIsSyncing(true);
    try {
      const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'rosterPlan', 'main');
      await setDoc(docRef, {
        employees, roster, notes, shifts, shiftOrder, columnOrder,
        updatedAt: serverTimestamp()
      }, { merge: true });
    } catch (e) { console.error("Cloud-Sicherung fehlgeschlagen", e); }
    setTimeout(() => setIsSyncing(false), 800);
  };

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const holidays = useMemo(() => getHolidaysNRW(year), [year]);
  
  const calculateWorkingDays = (y, m) => {
    const h = getHolidaysNRW(y);
    let count = 0;
    const d = new Date(y, m, 1);
    while (d.getMonth() === m) {
      const k = d.toISOString().split('T')[0];
      if (d.getDay() !== 0 && d.getDay() !== 6 && !h[k]) count++;
      d.setDate(d.getDate() + 1);
    }
    return count;
  };
  const workDays = useMemo(() => calculateWorkingDays(year, month), [year, month]);
  const monthSollBase = workDays * 7.7;

  const visibleDays = useMemo(() => {
    const days = [];
    const date = new Date(year, month, 1);
    while (date.getMonth() === month) {
      days.push(new Date(date));
      date.setDate(date.getDate() + 1);
    }
    return viewMode === 'month' ? days : days.slice(0, 7);
  }, [year, month, viewMode]);

  const toggleShift = (empId, date) => {
    if (!isEditMode) return;
    const dateKey = date.toISOString().split('T')[0];
    
    if (activeShift === 'NOTE') {
      const currentNote = (notes[empId] || {})[dateKey] || "";
      const text = prompt("Notiz für den " + date.toLocaleDateString() + ":", currentNote);
      if (text !== null) {
        setNotes(prev => ({
          ...prev,
          [empId]: { ...(prev[empId] || {}), [dateKey]: text }
        }));
      }
      return;
    }

    setRoster(prev => {
      const empRoster = { ...(prev[empId] || {}) };
      empRoster[dateKey] = empRoster[dateKey] === activeShift ? null : activeShift;
      return { ...prev, [empId]: empRoster };
    });
  };

  const getDayCounts = (date) => {
    const key = date.toISOString().split('T')[0];
    const counts = { FD: 0, SD: 0, ND: 0, ZD: 0 };
    Object.values(roster).forEach(empRost => {
      const s = empRost[key];
      if (counts[s] !== undefined) counts[s]++;
    });
    return counts;
  };

  const handleDragStart = (e, type, index) => {
    if (!isEditMode) return e.preventDefault();
    setDragItem({ type, index });
  };

  const handleDragOver = (e) => {
    e.preventDefault();
  };

  const handleDrop = (e, type, index) => {
    if (!isEditMode || !dragItem || dragItem.type !== type) return;
    if (type === 'employee') {
      const list = [...employees];
      const [moved] = list.splice(dragItem.index, 1);
      list.splice(index, 0, moved);
      setEmployees(list);
    } else if (type === 'column') {
      const list = [...columnOrder];
      const [moved] = list.splice(dragItem.index, 1);
      list.splice(index, 0, moved);
      setColumnOrder(list);
    }
    setDragItem(null);
  };

  return (
    <div className={`min-h-screen ${isDarkMode ? 'bg-[#020617] text-slate-200' : 'bg-slate-50 text-slate-900'} font-sans p-2 md:p-4 overflow-hidden flex flex-col transition-all duration-300`}>
      <header className={`flex flex-wrap items-center justify-between mb-4 bg-white/5 backdrop-blur-3xl border border-white/10 p-3 rounded-2xl no-print`}>
        <div className="flex items-center gap-4">
          <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-500 rounded-xl flex items-center justify-center">
            <Calendar className="text-white" size={20} />
          </div>
          <div>
            <h1 className="text-lg font-black tracking-tight leading-none">Dienstplan PRO</h1>
            <div className="flex items-center gap-2 mt-1">
              <span className={`text-[8px] font-black uppercase px-1.5 py-0.5 rounded ${isSyncing ? 'bg-blue-500/20 text-blue-400' : 'bg-emerald-500/20 text-emerald-400'}`}>
                {isSyncing ? 'Synchronisierung...' : 'Live-Sync Aktiv'}
              </span>
              <span className="text-[9px] text-slate-500 font-bold uppercase tracking-widest">{workDays} Arbeitstage</span>
            </div>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <div className="flex items-center bg-black/40 p-1 rounded-xl border border-white/5">
            <button onClick={() => setCurrentDate(new Date(year, month - 1, 1))} className="p-1 hover:bg-white/10 rounded-lg"><ChevronLeft size={16}/></button>
            <div onClick={() => setIsYearOpen(true)} className="px-3 font-bold text-xs min-w-[120px] text-center uppercase tracking-wider cursor-pointer hover:text-blue-400 transition-colors">
              {currentDate.toLocaleString('de-DE', { month: 'long', year: 'numeric' })}
            </div>
            <button onClick={() => setCurrentDate(new Date(year, month + 1, 1))} className="p-1 hover:bg-white/10 rounded-lg"><ChevronRight size={16}/></button>
          </div>

          <div className="hidden lg:flex items-center gap-2 px-3 py-1 bg-black/40 rounded-xl border border-white/5">
            <Minimize size={14} className="text-slate-500"/>
            <input type="range" min="0.5" max="1.5" step="0.05" value={zoom} onChange={(e) => setZoom(parseFloat(e.target.value))} className="w-20 h-1 appearance-none bg-blue-600/20 rounded-full cursor-pointer accent-blue-500" />
            <Maximize size={14} className="text-slate-500"/>
          </div>

          <div className="flex items-center gap-2">
            <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 hover:bg-white/10 rounded-xl text-slate-400 transition-all">
              {isDarkMode ? <Sun size={18}/> : <Moon size={18}/>}
            </button>
            <button 
              onClick={() => setIsEditMode(!isEditMode)} 
              className={`p-2 rounded-xl border transition-all ${isEditMode ? 'bg-emerald-500/20 border-emerald-500/50 text-emerald-400 shadow-lg' : 'bg-white/5 border-white/10 text-slate-400'}`}
            >
              {isEditMode ? <Unlock size={18} /> : <Lock size={18} />}
            </button>
            <button onClick={() => setIsSettingsOpen(true)} className="p-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-slate-400"><Settings size={18}/></button>
            <button onClick={() => setIsInfoOpen(true)} className="p-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-blue-400"><Info size={18} /></button>
            <button onClick={saveToCloud} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-xl text-xs font-black shadow-lg flex items-center gap-2 transition-all">
              <Save size={14} className={isSyncing ? 'animate-spin' : ''}/> Sichern
            </button>
          </div>
        </div>
      </header>

      <div className="flex flex-1 gap-4 overflow-hidden relative">
        <aside className="w-14 md:w-44 flex flex-col gap-3 overflow-y-auto no-scrollbar pb-20 no-print">
          <div className={`p-3 rounded-2xl border ${isDarkMode ? 'bg-white/5 border-white/10' : 'bg-white border-slate-200'}`}>
            <p className="text-[10px] font-black text-slate-500 mb-3 uppercase hidden md:flex items-center gap-2"><Layout size={12}/> Palette</p>
            <div className="flex flex-col gap-2">
              <button 
                onClick={() => setActiveShift('NOTE')}
                className={`flex items-center gap-3 p-1.5 rounded-xl border transition-all ${activeShift === 'NOTE' ? 'bg-amber-600/20 border-amber-600 scale-105' : 'bg-black/20 border-white/5'}`}
              >
                <div className="w-8 h-8 rounded-lg bg-amber-500 flex items-center justify-center shadow-sm">
                  <StickyNote className="text-amber-950" size={14}/>
                </div>
                <span className="text-[10px] font-black hidden md:block uppercase truncate">Notiz</span>
              </button>
              
              {shiftOrder.map(key => {
                const cfg = shifts[key];
                return (
                  <button 
                    key={key}
                    onClick={() => setActiveShift(key)}
                    className={`flex items-center gap-3 p-1.5 rounded-xl border transition-all ${activeShift === key ? 'bg-blue-600/20 border-blue-600 scale-105' : 'bg-black/20 border-white/5'}`}
                  >
                    <div className={`w-8 h-8 rounded-lg ${cfg.color} flex items-center justify-center shadow-sm`}>
                      <span className={`text-[10px] font-black ${cfg.textColor}`}>{key}</span>
                    </div>
                    <span className="text-[10px] font-black hidden md:block uppercase truncate">{cfg.label}</span>
                  </button>
                );
              })}
            </div>
          </div>
          
          <button 
            onClick={() => setViewMode(viewMode === 'month' ? 'week' : 'month')}
            className="w-full py-3 bg-white/5 border border-white/10 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-all text-slate-500"
          >
            {viewMode === 'month' ? <Monitor size={18}/> : <Smartphone size={18}/>}
            <span className="text-[8px] font-black uppercase tracking-widest">{viewMode === 'month' ? 'Woche' : 'Monat'}</span>
          </button>
        </aside>

        <main className={`flex-1 border rounded-2xl overflow-hidden flex flex-col shadow-2xl ${isDarkMode ? 'bg-white/5 border-white/10' : 'bg-white border-slate-200'}`}>
          <div className="overflow-x-auto overflow-y-auto flex-1 custom-scrollbar" style={{ transform: `scale(${zoom})`, transformOrigin: 'top left', width: `${100/zoom}%`, height: `${100/zoom}%` }}>
            <table className="w-full border-separate border-spacing-0">
              <thead>
                <tr className={`${isDarkMode ? 'bg-slate-900' : 'bg-slate-100'} sticky top-0 z-[70]`}>
                  <th className={`p-3 text-left text-[10px] font-black border-b border-white/10 sticky left-0 z-[80] min-w-[160px] uppercase ${isDarkMode ? 'bg-slate-900' : 'bg-slate-100'}`}>Mitarbeiter</th>
                  
                  {columnOrder.map((key, idx) => (
                    <th 
                      key={key} 
                      draggable={isEditMode}
                      onDragStart={(e) => handleDragStart(e, 'column', idx)}
                      onDragOver={handleDragOver}
                      onDrop={(e) => handleDrop(e, 'column', idx)}
                      className={`p-2 text-center text-[10px] font-black border-b border-white/10 uppercase ${isEditMode ? 'cursor-move hover:bg-white/5' : ''}`}
                    >
                      <div className="flex items-center justify-center gap-1">
                        {isEditMode && <GripVertical size={10} className="text-slate-600" />}
                        {key === 'status' ? 'VZ' : key === 'soll' ? 'Soll' : key === 'ist' ? 'Ist' : key === 'diff' ? '+/-' : 'Vmt'}
                      </div>
                    </th>
                  ))}

                  {visibleDays.map(day => {
                    const k = day.toISOString().split('T')[0];
                    const counts = getDayCounts(day);
                    const isH = !!holidays[k];
                    const isW = day.getDay() === 0 || day.getDay() === 6;
                    const lowStaff = (counts.FD < 3 || counts.SD < 3) && !isW;

                    return (
                      <th key={k} className={`p-2 border-b border-white/10 min-w-[55px] ${isH ? 'bg-amber-500/20' : isW ? 'bg-blue-500/10' : ''}`}>
                        <div className="flex flex-col items-center relative">
                          {lowStaff && <div className="absolute -top-1 -right-1 text-rose-500 animate-pulse" title="Unterbesetzung! (FD/SD < 3)"><AlertTriangle size={10}/></div>}
                          <span className="text-[8px] uppercase font-bold opacity-50">{day.toLocaleDateString('de-DE', { weekday: 'short' })}</span>
                          <span className={`text-xs font-black ${isH ? 'text-amber-400' : isDarkMode ? 'text-slate-200' : 'text-slate-800'}`}>{day.getDate()}</span>
                        </div>
                      </th>
                    );
                  })}
                </tr>
              </thead>
              <tbody>
                {employees.map((emp, rIdx) => {
                  const empSoll = monthSollBase * (parseInt(emp.status) / 100);
                  const empRost = roster[emp.id] || {};
                  const empNotes = notes[emp.id] || {};
                  const ist = Object.values(empRost).reduce((acc, code) => acc + (shifts[code]?.hours || 0), 0);
                  const diff = ist - empSoll;

                  return (
                    <tr 
                      key={emp.id} 
                      onDragOver={handleDragOver}
                      onDrop={(e) => handleDrop(e, 'employee', rIdx)}
                      className="group transition-colors"
                    >
                      <td 
                        draggable={isEditMode}
                        onDragStart={(e) => handleDragStart(e, 'employee', rIdx)}
                        className={`p-3 sticky left-0 z-40 border-r border-white/5 shadow-xl ${isDarkMode ? 'bg-[#0f172a]' : 'bg-white'} ${isEditMode ? 'cursor-move' : ''}`}
                      >
                        <div className="flex items-center gap-2">
                          {isEditMode && <GripVertical size={12} className="text-slate-600"/>}
                          <div onClick={() => isEditMode && prompt("Mitarbeiter bearbeiten:", emp.name)}>
                            <div className="font-black text-[11px] uppercase whitespace-nowrap">{emp.name}</div>
                            <div className="text-[8px] text-slate-500 font-bold uppercase tracking-tighter">{emp.role}</div>
                          </div>
                        </div>
                      </td>
                      
                      {columnOrder.map(key => {
                        if (key === 'status') return <td key={key} className="p-2 text-center text-[10px] font-bold text-slate-400 border-r border-white/5">{emp.status}</td>;
                        if (key === 'soll') return <td key={key} className="p-2 text-center text-[10px] font-mono text-slate-500 border-r border-white/5">{empSoll.toFixed(0)}</td>;
                        if (key === 'ist') return <td key={key} className="p-2 text-center text-[11px] font-black border-r border-white/5">{ist.toFixed(0)}</td>;
                        if (key === 'diff') return <td key={key} className={`p-2 text-center text-[10px] font-black border-r border-white/5 ${diff >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{diff > 0 ? '+' : ''}{diff.toFixed(0)}</td>;
                        if (key === 'prev') return <td key={key} className="p-2 text-center text-[10px] font-black text-blue-500 border-r border-white/5">{emp.prevOvertime}</td>;
                        return null;
                      })}

                      {visibleDays.map(day => {
                        const k = day.toISOString().split('T')[0];
                        const s = empRost[k];
                        const n = empNotes[k];
                        const isH = !!holidays[k];
                        return (
                          <td 
                            key={k} 
                            onClick={() => toggleShift(emp.id, day)}
                            className={`p-1 border-r border-white/[0.02] text-center ${isH ? 'bg-amber-500/5' : ''} ${isEditMode ? 'cursor-pointer' : 'cursor-default'}`}
                          >
                            <div className={`min-h-[40px] w-full rounded-lg flex flex-col items-center justify-center transition-all p-0.5 ${s ? `${shifts[s].color} ${shifts[s].textColor} shadow-lg scale-105` : 'hover:bg-white/5'}`}>
                              <span className="text-[10px] font-black leading-none">{s || ''}</span>
                              {n && <span className="text-[6px] font-black leading-tight mt-0.5 opacity-95 uppercase line-clamp-2 break-all text-current bg-white/10 rounded px-0.5">{n}</span>}
                            </div>
                          </td>
                        );
                      })}
                    </tr>
                  );
                })}
              </tbody>
              <tfoot>
                <tr className={`${isDarkMode ? 'bg-slate-900' : 'bg-slate-100'} sticky bottom-0 z-[70] border-t border-white/10`}>
                  <td className={`p-2 font-black text-[9px] uppercase sticky left-0 z-[80] ${isDarkMode ? 'bg-slate-900' : 'bg-slate-100'}`}>Summen (FD/SD/ND)</td>
                  <td colSpan={columnOrder.length} className="border-r border-white/5"></td>
                  {visibleDays.map(day => {
                    const c = getDayCounts(day);
                    return (
                      <td key={day.getTime()} className="p-1 text-center text-[8px] font-black border-r border-white/5">
                        <div className="flex flex-col gap-0.5">
                          <span className="text-cyan-400" title="Frühdienst">{c.FD}</span>
                          <span className="text-fuchsia-500" title="Spätdienst">{c.SD}</span>
                          <span className="text-orange-500" title="Nachtdienst">{c.ND}</span>
                        </div>
                      </td>
                    );
                  })}
                </tr>
              </tfoot>
            </table>
          </div>
        </main>
      </div>

      {isYearOpen && (
        <div className="fixed inset-0 z-[300] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/80 backdrop-blur-md" onClick={() => setIsYearOpen(false)}></div>
          <div className="relative bg-[#0f172a] border border-white/10 rounded-[32px] w-full max-w-2xl p-8 animate-in zoom-in duration-300">
            <h2 className="text-2xl font-black mb-6 flex items-center gap-3"><Calendar className="text-blue-500" /> Jahresübersicht {year}</h2>
            <div className="grid grid-cols-3 md:grid-cols-4 gap-3">
              {[...Array(12)].map((_, i) => (
                <button 
                  key={i}
                  onClick={() => { setCurrentDate(new Date(year, i, 1)); setIsYearOpen(false); }}
                  className={`p-4 rounded-2xl font-black text-xs uppercase border transition-all ${month === i ? 'bg-blue-600 border-blue-400 text-white' : 'bg-white/5 border-white/10 hover:bg-white/10'}`}
                >
                  {new Date(year, i, 1).toLocaleString('de-DE', { month: 'long' })}
                </button>
              ))}
            </div>
            <button onClick={() => setIsYearOpen(false)} className="mt-8 w-full py-4 bg-white/5 rounded-2xl font-black uppercase text-xs">Schließen</button>
          </div>
        </div>
      )}

      {isSettingsOpen && (
        <div className="fixed inset-0 z-[300] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/80 backdrop-blur-md" onClick={() => setIsSettingsOpen(false)}></div>
          <div className="relative bg-[#0f172a] border border-white/10 rounded-[32px] w-full max-w-lg p-8 animate-in zoom-in duration-300">
            <h2 className="text-2xl font-black mb-6 flex items-center gap-3"><Settings className="text-slate-400" /> Einstellungen</h2>
            <div className="space-y-6">
              <div>
                <p className="text-[10px] font-black uppercase text-slate-500 mb-2 tracking-widest">Mitarbeiter hinzufügen</p>
                <button 
                  onClick={() => {
                    const n = prompt("Name, Vorname:");
                    if (n) setEmployees([...employees, { id: Date.now().toString(), name: n, role: 'Pflegekraft', status: '100%', prevOvertime: 0 }]);
                  }}
                  className="w-full py-3 bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 rounded-2xl font-black text-xs uppercase flex items-center justify-center gap-2"
                >
                  <UserPlus size={14}/> Neuen Kollegen anlegen
                </button>
              </div>
              <div>
                <p className="text-[10px] font-black uppercase text-slate-500 mb-2 tracking-widest">Sichtbare Spalten</p>
                <div className="flex flex-wrap gap-2">
                  {['status', 'soll', 'ist', 'diff', 'prev'].map(key => (
                    <button 
                      key={key}
                      onClick={() => setColumnOrder(prev => prev.includes(key) ? prev.filter(k => k !== key) : [...prev, key])}
                      className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase border transition-all ${columnOrder.includes(key) ? 'bg-blue-600 border-blue-400' : 'bg-white/5 border-white/10 opacity-40'}`}
                    >
                      {key}
                    </button>
                  ))}
                </div>
              </div>
            </div>
            <button onClick={() => setIsSettingsOpen(false)} className="mt-8 w-full py-4 bg-white/5 rounded-2xl font-black uppercase text-xs">Schließen</button>
          </div>
        </div>
      )}

      {isInfoOpen && (
        <div className="fixed inset-0 z-[300] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/80 backdrop-blur-md" onClick={() => setIsInfoOpen(false)}></div>
          <div className="relative bg-[#0f172a] border border-white/10 rounded-[32px] w-full max-w-3xl max-h-[90vh] overflow-y-auto p-8 animate-in zoom-in duration-300 custom-scrollbar">
            <h2 className="text-2xl font-black mb-4 tracking-tight">Feature-Übersicht: Dienstplan Pro</h2>
            <div className="space-y-6 text-slate-300 text-xs leading-relaxed">
              <div className="bg-blue-600/10 border border-blue-500/20 p-4 rounded-2xl italic font-bold">
                "Dieses Programm wurde speziell für die Anforderungen einer pflegerischen Leitung in der Notfallpflege entwickelt. Es kombiniert maximale Flexibilität mit automatisierter Logik."
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <section>
                  <h3 className="font-black uppercase text-white mb-2 flex items-center gap-2"><Cloud className="text-blue-400" size={14}/> 1. Daten & Sicherheit</h3>
                  <ul className="list-disc pl-4 space-y-1 opacity-80">
                    <li>Echtzeit-Cloud-Sync via Firebase</li>
                    <li>Edit-Modus (Schloss) schützt vor Fehlklicks</li>
                  </ul>
                </section>
                <section>
                  <h3 className="font-black uppercase text-white mb-2 flex items-center gap-2"><AlertTriangle className="text-rose-400" size={14}/> 2. Logik & Warnungen</h3>
                  <ul className="list-disc pl-4 space-y-1 opacity-80">
                    <li>NRW-Feiertage werden live berechnet</li>
                    <li>Warnsymbol bei Besetzung unter 3 Personen (FD/SD)</li>
                  </ul>
                </section>
              </div>
            </div>
            <button onClick={() => setIsInfoOpen(false)} className="mt-8 w-full py-4 bg-blue-600 rounded-2xl font-black uppercase text-xs shadow-xl">Verstanden</button>
          </div>
        </div>
      )}

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #3b82f6; cursor: pointer; border: 2px solid #fff; }
        @media print {
          body { background: white !important; color: black !important; padding: 0 !important; }
          header, aside, .no-print, tfoot { display: none !important; }
          main { border: none !important; width: 100vw !important; transform: scale(1) !important; }
          table { width: 100% !important; border-collapse: collapse !important; font-size: 7pt; }
          td, th { border: 0.1pt solid #ccc !important; color: black !important; background: white !important; }
        }
      `}</style>
    </div>
  );
};

export default App;
